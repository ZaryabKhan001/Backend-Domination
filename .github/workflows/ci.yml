name: Microservices CI

on:
  push:
    branches:
      - part2/microservices-project

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Install Docker Compose
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # 4️⃣ Detect changed services
      - name: Detect changed services
        id: changes
        run: |
          echo "CHANGED_SERVICES="
          for dir in api-gateway identity-service post-service media-service search-service; do
            if git diff --name-only HEAD~1 HEAD | grep "^PartTwo/04_microservices/$dir/"; then
              echo "$dir "
              echo "$dir" >> changed_services.txt
            fi
          done
          echo "::set-output name=services::$(cat changed_services.txt || true)"

      # 5️⃣ Create minimal .env files for CI
      - name: Create env files for CI
        run: |
          for service in $(cat changed_services.txt); do
            mkdir -p ./PartTwo/04_microservices/$service
            case $service in
              api-gateway)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/api-gateway/.env
                ;;
              identity-service|post-service|media-service)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/$service/.env
                echo "RABBITMQ_URL=amqp://rabbitmq:5672" >> ./PartTwo/04_microservices/$service/.env
                ;;
              search-service)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/search-service/.env
                echo "RABBITMQ_URL=amqp://rabbitmq:5672" >> ./PartTwo/04_microservices/search-service/.env
                echo "ELASTICSEARCH_URL=http://elasticsearch:9200" >> ./PartTwo/04_microservices/search-service/.env
                echo "ELASTIC_USERNAME=elastic" >> ./PartTwo/04_microservices/search-service/.env
                echo "ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}" >> ./PartTwo/04_microservices/search-service/.env
                ;;
            esac
          done

      # 6️⃣ Build only changed services
      - name: Build Docker Images
        run: |
          for service in $(cat changed_services.txt); do
            docker-compose build $service
          done
        working-directory: ./PartTwo/04_microservices

      # 7️⃣ Test only changed services
      - name: Test changed services
        run: |
          for service in $(cat changed_services.txt); do
            docker-compose run --rm $service npm test
          done
        working-directory: ./PartTwo/04_microservices

      # 8️⃣ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 9️⃣ Push only changed services
      - name: Push Docker Images
        run: |
          for service in $(cat changed_services.txt); do
            docker-compose push $service
          done
        working-directory: ./PartTwo/04_microservices
