name: Microservices CI/CD

on:
  push:
    branches:
      - part2/microservices-project

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code with full history to detect changes
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2️⃣ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Install Docker Compose
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # 4️⃣ Detect changed services
      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting changed services..."
          > changed_services.txt
          for service in api-gateway identity-service post-service media-service search-service; do
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^PartTwo/04_microservices/$service/" >/dev/null; then
              echo "$service" >> changed_services.txt
            fi
          done

          if [ -s changed_services.txt ]; then
            echo "Changed services detected:"
            cat changed_services.txt
            echo "CHANGED_SERVICES=$(paste -sd ',' changed_services.txt)" >> $GITHUB_ENV
          else
            echo "No changed services detected"
            echo "CHANGED_SERVICES=" >> $GITHUB_ENV
          fi
        shell: bash

      # 5️⃣ Create minimal .env files for changed services
      - name: Create env files for changed services
        if: ${{ env.CHANGED_SERVICES != '' }}
        run: |
          for service in $(echo $CHANGED_SERVICES | tr ',' ' '); do
            mkdir -p ./PartTwo/04_microservices/$service
            case $service in
              api-gateway)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/$service/.env
                ;;
              identity-service|post-service|media-service)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/$service/.env
                echo "RABBITMQ_URL=amqp://rabbitmq:5672" >> ./PartTwo/04_microservices/$service/.env
                ;;
              search-service)
                echo "REDIS_URL=redis://redis:6379" > ./PartTwo/04_microservices/$service/.env
                echo "RABBITMQ_URL=amqp://rabbitmq:5672" >> ./PartTwo/04_microservices/$service/.env
                echo "ELASTICSEARCH_URL=http://elasticsearch:9200" >> ./PartTwo/04_microservices/$service/.env
                echo "ELASTIC_USERNAME=elastic" >> ./PartTwo/04_microservices/$service/.env
                echo "ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}" >> ./PartTwo/04_microservices/$service/.env
                ;;
            esac
          done
        working-directory: ./PartTwo/04_microservices
        shell: bash

      # 6️⃣ Build Docker images for changed services
      - name: Build Docker images
        if: ${{ env.CHANGED_SERVICES != '' }}
        run: |
          for service in $(echo $CHANGED_SERVICES | tr ',' ' '); do
            echo "Building $service..."
            docker-compose build $service
          done
        working-directory: ./PartTwo/04_microservices
        shell: bash

      # 7️⃣ Run tests for changed services
      - name: Test Docker services
        if: ${{ env.CHANGED_SERVICES != '' }}
        run: |
          for service in $(echo $CHANGED_SERVICES | tr ',' ' '); do
            echo "Testing $service..."
            docker-compose run --rm $service npm test
          done
        working-directory: ./PartTwo/04_microservices
        shell: bash

      # 8️⃣ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 9️⃣ Push Docker images for changed services
      - name: Push Docker images
        if: ${{ env.CHANGED_SERVICES != '' }}
        run: |
          for service in $(echo $CHANGED_SERVICES | tr ',' ' '); do
            echo "Pushing $service..."
            docker-compose push $service
          done
        working-directory: ./PartTwo/04_microservices
        shell: bash
