name: Microservices CI/CD

on:
  push:
    branches:
      - part2/microservices-project

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      # Core service URLs
      REDIS_URL: ${{ secrets.REDIS_URL }}
      RABBITMQ_URL: ${{ secrets.RABBITMQ_URL }}
      ELASTICSEARCH_URL: ${{ secrets.ELASTICSEARCH_URL }}
      ELASTIC_USERNAME: ${{ secrets.ELASTIC_USERNAME }}

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history for proper git diff

      # 2️⃣ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Install Docker Compose
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.18.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version

      # 4️⃣ Detect changed services
      - name: Detect changed services
        id: detect
        run: |
          CHANGED=""
          SERVICES="api-gateway identity-service post-service media-service search-service"
          for service in $SERVICES; do
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "PartTwo/04_microservices/$service/" >/dev/null; then
              CHANGED="$CHANGED $service"
            fi
          done
          CHANGED=$(echo $CHANGED | xargs)
          echo "Changed services: $CHANGED"
          echo "changed_services=$CHANGED" >> $GITHUB_ENV

      # 5️⃣ Login to Docker Hub
      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6️⃣ Build, Test & Push Changed Services
      - name: Build, Test & Push Changed Services
        if: ${{ env.changed_services != '' }}
        env:
          # Service secrets
          API_GATEWAY_JWT_SECRET: ${{ secrets.API_GATEWAY_JWT_SECRET }}
          IDENTITY_SERVICE_JWT_SECRET: ${{ secrets.IDENTITY_SERVICE_JWT_SECRET }}
          IDENTITY_SERVICE_MONGO_URI: ${{ secrets.IDENTITY_SERVICE_MONGO_URI }}
          POST_SERVICE_JWT_SECRET: ${{ secrets.POST_SERVICE_JWT_SECRET }}
          POST_SERVICE_MONGO_URI: ${{ secrets.POST_SERVICE_MONGO_URI }}
          MEDIA_SERVICE_JWT_SECRET: ${{ secrets.MEDIA_SERVICE_JWT_SECRET }}
          MEDIA_SERVICE_MONGO_URI: ${{ secrets.MEDIA_SERVICE_MONGO_URI }}
          MEDIA_SERVICE_CLOUDINARY_NAME: ${{ secrets.MEDIA_SERVICE_CLOUDINARY_NAME }}
          MEDIA_SERVICE_CLOUDINARY_KEY: ${{ secrets.MEDIA_SERVICE_CLOUDINARY_KEY }}
          MEDIA_SERVICE_CLOUDINARY_SECRET: ${{ secrets.MEDIA_SERVICE_CLOUDINARY_SECRET }}
          SEARCH_SERVICE_JWT_SECRET: ${{ secrets.SEARCH_SERVICE_JWT_SECRET }}
          SEARCH_SERVICE_MONGO_URI: ${{ secrets.SEARCH_SERVICE_MONGO_URI }}
          ELASTIC_PASSWORD: ${{ secrets.ELASTIC_PASSWORD }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          cd PartTwo/04_microservices

          # Start core dependencies
          docker-compose up -d redis rabbitmq elasticsearch || true

          # Prepare common envs for all services
          COMMON_ENVS="-e REDIS_URL=$REDIS_URL -e RABBITMQ_URL=$RABBITMQ_URL -e ELASTICSEARCH_URL=$ELASTICSEARCH_URL -e ELASTIC_USERNAME=$ELASTIC_USERNAME -e ELASTIC_PASSWORD=$ELASTIC_PASSWORD"

          for service in $changed_services; do
            echo "==== Building $service ===="
            docker-compose build $service

            echo "==== Testing $service ===="
            case $service in
              api-gateway)
                docker-compose run --rm --no-deps $COMMON_ENVS \
                  -e JWT_SECRET=$API_GATEWAY_JWT_SECRET \
                  -e IDENTITY_SERVICE_URL=http://identity-service:3001 \
                  -e POST_SERVICE_URL=http://post-service:3002 \
                  -e MEDIA_SERVICE_URL=http://media-service:3003 \
                  -e SEARCH_SERVICE_URL=http://search-service:3004 \
                  $service npm test
                ;;
              identity-service)
                docker-compose run --rm --no-deps $COMMON_ENVS \
                  -e JWT_SECRET=$IDENTITY_SERVICE_JWT_SECRET \
                  -e MONGODB_URI=$IDENTITY_SERVICE_MONGO_URI \
                  $service npm test
                ;;
              post-service)
                docker-compose run --rm --no-deps $COMMON_ENVS \
                  -e JWT_SECRET=$POST_SERVICE_JWT_SECRET \
                  -e MONGODB_URI=$POST_SERVICE_MONGO_URI \
                  $service npm test
                ;;
              media-service)
                docker-compose run --rm --no-deps $COMMON_ENVS \
                  -e JWT_SECRET=$MEDIA_SERVICE_JWT_SECRET \
                  -e MONGODB_URI=$MEDIA_SERVICE_MONGO_URI \
                  -e CLOUDINARY_CLOUD_NAME=$MEDIA_SERVICE_CLOUDINARY_NAME \
                  -e CLOUDINARY_API_KEY=$MEDIA_SERVICE_CLOUDINARY_KEY \
                  -e CLOUDINARY_API_SECRET=$MEDIA_SERVICE_CLOUDINARY_SECRET \
                  $service npm test
                ;;
              search-service)
                docker-compose run --rm --no-deps $COMMON_ENVS \
                  -e JWT_SECRET=$SEARCH_SERVICE_JWT_SECRET \
                  -e MONGODB_URI=$SEARCH_SERVICE_MONGO_URI \
                  $service npm test
                ;;
            esac

            echo "==== Pushing $service ===="
            docker-compose push $service
          done

          # Shutdown dependencies
          docker-compose down
